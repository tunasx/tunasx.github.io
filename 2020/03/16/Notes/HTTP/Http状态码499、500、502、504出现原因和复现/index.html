<!DOCTYPE html><html><head hexo-theme="https://volantis.js.org/#">
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>Http状态码499、500、502、504出现原因和复现 - Mr.Tunas</title>
  
    <meta name="keywords" content="Editing,Http">
  
  
    <meta name="description" content="499状态码首先 499 并不是HTTP 协议定义的状态码，而是 Nginx 自己定义的状态码，看下 Nginx 对 499 状态码的定义  
1234567/* * HTTP does not define the code for the case when a client closed * the con...">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    <cover class="cover post half">
      
        
  <p class="title ">Mr. Tunas</p>
  
    <p class="subtitle ">「Forgetting Is Death」</p>
  


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <i class="icon fas fa-search fa-fw"></i>
      <input type="text" class="input u-search-input" placeholder="^_^ 你在找什么">
    </form>
  </div>

<div class="menu navigation">
  <ul class="h-list">
    
      
        <li>
          <a class="nav home " href="/" id="home">
            <i class="fas fa-home fa-fw"></i> 主页
          </a>
        </li>
      
        <li>
          <a class="nav home " href="/news/archives/" id="newsarchives">
            <i class="fas fa-bullhorn fa-fw"></i> 公告
          </a>
        </li>
      
        <li>
          <a class="nav home " href="/archives/" id="archives">
            <i class="fas fa-book fa-fw"></i> 归档
          </a>
        </li>
      
        <li>
          <a class="nav home " href="https://volantis.js.org/examples/" id="https:volantis.js.orgexamples">
            <i class="fas fa-play-circle fa-fw"></i> 示例
          </a>
        </li>
      
        <li>
          <a class="nav home " href="https://github.com/xaoxuu/hexo-theme-volantis/" rel="external nofollow noopener noreferrer" target="_blank" id="https:github.comxaoxuuhexo-theme-volantis">
            <i class="fas fa-file-code fa-fw"></i> 源码
          </a>
        </li>
      
    
  </ul>
</div>

      
      
    </cover>
    <header class="l_header nav-blur">
  <div id="loading-bar-wrapper">
    <div id="loading-bar"></div>
  </div>
	<div class="wrapper">
		<div class="nav-main container container--flex">
      
        <a class="logo flat-box" target="_self" href="/">
          
            
              MR. TUNAS <sup style="color:#2196f3"></sup>
            
          
        </a>
      

			<div class="menu navigation">
				<ul class="h-list">
          
          
            <li>
              <a class="nav flat-box" href="/" id="home">
                <i class="fas fa-rss fa-fw"></i> 博客
              </a>
            </li>
          
            <li>
              <a class="nav flat-box" href="/categories/" id="categories">
                <i class="fas fa-folder-open fa-fw"></i> 分类
              </a>
            </li>
          
            <li>
              <a class="nav flat-box" href="/tags/" id="tags">
                <i class="fas fa-tags fa-fw"></i> 标签
              </a>
            </li>
          
            <li>
              <a class="nav flat-box" href="/archives/" id="archives">
                <i class="fas fa-archive fa-fw"></i> 归档
              </a>
            </li>
          
            <li>
              <a class="nav flat-box" href="/friends/" id="friends">
                <i class="fas fa-link fa-fw"></i> 友链
              </a>
            </li>
          
            <li>
              <a class="nav flat-box" href="/about/" id="about">
                <i class="fas fa-info-circle fa-fw"></i> 关于
              </a>
            </li>
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="搜索一下">
        </form>
      </div>

			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" target="_self" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" target="_self" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" target="_self" href="javascript:void(0)"></a></li>
        
          <li class="s-toc"><a class="flat-btn fas fa-list fa-fw" target="_self" href="javascript:void(0)"></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone white-box">
    <header>
		<nav class="menu navigation">
      <ul>
        
        
          <li>
            <a class="nav flat-box" href="/" id="home">
              <i class="fas fa-rss fa-fw"></i> 博客
            </a>
          </li>
        
          <li>
            <a class="nav flat-box" href="/categories/" id="categories">
              <i class="fas fa-folder-open fa-fw"></i> 分类
            </a>
          </li>
        
          <li>
            <a class="nav flat-box" href="/tags/" id="tags">
              <i class="fas fa-tags fa-fw"></i> 标签
            </a>
          </li>
        
          <li>
            <a class="nav flat-box" href="/archives/" id="archives">
              <i class="fas fa-archive fa-fw"></i> 归档
            </a>
          </li>
        
          <li>
            <a class="nav flat-box" href="/friends/" id="friends">
              <i class="fas fa-link fa-fw"></i> 友链
            </a>
          </li>
        
          <li>
            <a class="nav flat-box" href="/about/" id="about">
              <i class="fas fa-info-circle fa-fw"></i> 关于
            </a>
          </li>
        
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class="body-wrapper">
      

<div class="l_main">
  

  
    <article id="post" class="post white-box card-shadow  article-type-post" itemscope itemprop="blogPost">
      


  <section class="meta">
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/">
        Http状态码499、500、502、504出现原因和复现
      </a>
    </h1>
  


      
      <div class="new-meta-box">
        
          
        
          
            
<div class="new-meta-item author">
  <a href rel="nofollow">
    <img src="/20200310.svg" data-original="https://cdn.jsdelivr.net/gh/tunasx/jdn/abstract/avatar2.png">
    <p>Mr. Tunas</p>
  </a>
</div>

          
        
          
            
  
  <div class="new-meta-item category">
    <a href="/categories/notes/" rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>notes</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class="notlink">
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：1.6k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class="notlink">
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：6分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class="notlink">
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2020年3月16日</p>
  </a>
</div>

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <h2 id="499状态码"><a href="#499状态码" class="headerlink" title="499状态码"></a>499状态码</h2><p>首先 <code>499</code> 并不是<code>HTTP</code> 协议定义的状态码，而是 <code>Nginx</code> 自己定义的状态码，看下 <code>Nginx</code> 对 <code>499</code> 状态码的定义  </p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * HTTP does not define the code for the case when a client closed</span></span><br><span class="line"><span class="comment"> * the connection while we are processing its request so we introduce</span></span><br><span class="line"><span class="comment"> * own code to log such situation when a client has closed the connection</span></span><br><span class="line"><span class="comment"> * before we even try to send the HTTP header to it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_HTTP_CLIENT_CLOSED_REQUEST     499</span></span><br></pre></td></tr></tbody></table></figure>

<a id="more"></a>

<p>可以看出499状态码是用来表示客户端主动关闭连接时的响应码<br>浏览器的默认请求超时时间一般会设置的很大， 例如 <code>chrome</code> 浏览器就设置为<a href="https://cs.chromium.org/chromium/src/net/socket/client_socket_pool.cc?sq=package:chromium&l=25" target="_blank" rel="noopener">5分钟</a><br><img src="/20200310.svg" data-original="https://cdn.jsdelivr.net/gh/tunasx/jdn/img/chrome_timeout.png" alt="chrome_timeout"><br>所以在浏览器中我们几乎遇不到 <code>499</code> 状态码, 一般见于服务之间通过 <code>Http</code> 方式调用时，请求方设置了请求的超时时间， 在请求超时时间内上游服务器无返回时，请求方主动关闭连接，这时上游服务器的日志将会记录一条 <code>499</code> 的错误日志</p>
<h3 id="复现499状态码"><a href="#复现499状态码" class="headerlink" title="复现499状态码"></a>复现499状态码</h3><p>我们使用 <code>Nginx</code> 和 <code>php-fpm</code> 来复现<br>首先我们来看几个超时时间的定义</p>
<ol>
<li>fastcgi_read_timeout<br> <code>Nginx</code> 接收上游 <code>fastcgi</code> 应用响应的超时时间  </li>
<li>request_terminate_timeout   <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; The timeout for serving a single request after which the worker process will</span><br><span class="line">; be killed. This option should be used when the 'max_execution_time' ini option</span><br><span class="line">; does not stop script execution for some reason. A value of '0' means 'off'.</span><br><span class="line">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Value: 0</span><br><span class="line">; request_terminate_timeout = 30</span><br></pre></td></tr></tbody></table></figure>
 <code>php-fpm</code> 的 <code>worker</code> 进程对单个请求的处理时间， 超时将会被 <code>KILL</code></li>
</ol>
<p>通过上面的两个参数我们就可以来复现 <code>499</code> 错误<br><strong>配置如下</strong><br>Nginx</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server{</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  m.test.com;</span><br><span class="line">    root /home/webroot;</span><br><span class="line">    index index.php;</span><br><span class="line"></span><br><span class="line">    location ~ / {</span><br><span class="line">        root /home/webroot;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_read_timeout 10;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  /home/webroot/index.php;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>PHP</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">< ?php</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'run'</span>;</span><br><span class="line">error_log(<span class="string">"run"</span>, <span class="number">3</span>, <span class="string">"/tmp/test.log"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p><code>PHP-FPM</code> 的 <code>request_terminate_timeout</code> 设置为 <code>30</code></p>
<p>执行下面的请求</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -m 3 表示超时时间设置为3s</span></span><br><span class="line">curl -I -m 3 -H <span class="string">"Host:m.test.com"</span> 127.0.0.1</span><br></pre></td></tr></tbody></table></figure>

<p>返回</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl: (28) Operation timed out after 3001 milliseconds with 0 bytes received</span><br></pre></td></tr></tbody></table></figure>

<p>看一下 <code>Nginx</code> 的 <code>access</code> 日志， 类似如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"m.test.com"</span> <span class="string">"HEAD / HTTP/1.1"</span> 499 0</span><br></pre></td></tr></tbody></table></figure>

<p>看一下 <code>/tmp/test.log</code> 发现有日志， 说明 <code>PHP</code> 脚本会继续执行完成</p>
<h2 id="500状态码"><a href="#500状态码" class="headerlink" title="500状态码"></a>500状态码</h2><blockquote>
<p>500 Internal Server Error 服务器内部错误，无法完成请求</p>
</blockquote>
<p>一般就是由脚本的语法错误引起的</p>
<h2 id="502状态码"><a href="#502状态码" class="headerlink" title="502状态码"></a>502状态码</h2><blockquote>
<p>502 Bad Gateway 充当网关或代理的服务器，从远端服务器接收到了一个无效的请求</p>
</blockquote>
<p>宏观上连接两个网络的设备均可成为网关， 具体到应用层 <code>HTTP</code> 协议, 网关就是指是转发其他服务器通信数据的服务器, 对于当前的测试环境场景， <code>Nginx</code> 就是网关<br><code>502</code> 并不是网关本身出现问题， 而是从上游服务器接收响应出现了问题， 例如上游服务器自身处理超时不能产生响应数据， 或者上游服务器没有按照协议响应的数据导致网关<br>不能正常解析</p>
<h3 id="复现502状态码"><a href="#复现502状态码" class="headerlink" title="复现502状态码"></a>复现502状态码</h3><ol>
<li>当 <code>PHP-FPM</code> 没有在运行时， 会产生 <code>502</code> 错误</li>
<li>当 <code>PHP</code> 脚本未在 <code>request_terminate_timeout</code> 设置的超时时间内完成处理时, <code>worker</code> 进程将被 <code>KILL</code> , 会产生 <code>502</code> 错误<br> 1) 将 <code>request_terminate_timeout</code> 设置为 <code>3</code><br> 2) <code>fastcgi_read_timeout</code> 设置为 <code>10</code><br> 3) <code>index.php</code> 的休眠时间设置为 <code>5</code></li>
</ol>
<p>执行下面的请求</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -H <span class="string">"Host:m.test.com"</span> 127.0.0.1</span><br></pre></td></tr></tbody></table></figure>

<p>返回</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 502 Bad Gateway</span><br><span class="line">Server: openresty/1.13.6.2</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>看下 <code>Nginx</code> 的 <code>access</code> 日志， 类似如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"m.test.com"</span> <span class="string">"HEAD / HTTP/1.1"</span> 502 644</span><br></pre></td></tr></tbody></table></figure>

<p>看下 <code>Nginx</code> 的 <code>error</code> 日志， 类似如下</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020/03/08 12:56:42 [error] 155#0: *17 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: 127.0.0.1, server: *.test.com, request: "HEAD / HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: "m.test.com"</span><br></pre></td></tr></tbody></table></figure>

<p>看下 <code>PHP-FPM</code> 的错误日志</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[08-Mar-2020 12:55:21] WARNING: [pool www] child 185, script '/home/webroot/index.php' (request: "HEAD /") execution timed out (3.886253 sec), terminating</span><br><span class="line">[08-Mar-2020 12:55:21] WARNING: [pool www] child 185 exited on signal 15 (SIGTERM) after 231.236784 seconds from start</span><br></pre></td></tr></tbody></table></figure>

<p>看一下 <code>/tmp/test.log</code> 发现并没有日志， 说明 <code>PHP</code> 脚本在超时后被 <code>KILL</code> 了</p>
<h2 id="504状态码"><a href="#504状态码" class="headerlink" title="504状态码"></a>504状态码</h2><blockquote>
<p>504 Gateway Time-out 充当网关或代理的服务器，未及时从远端服务器获取请求  </p>
</blockquote>
<p>表示网关没有在设置的超时时间内获得上游服务器的响应数据， 注意和 <code>502</code> 的区别， <code>502</code> 是指上游服务器处理在自身设置的超时时间内没有处理完请求，进程被 <code>KILL</code> 无法正常响应数据造成的， <code>504</code> 是 <code>PHP</code> 脚本在处理请求的某一刻已经超过了 <code>Nginx</code> 设置的超时时间， 但并没有超过自身设置的超时时间。<br><code>Nginx</code> 服务器由于上游服务器没能按时返回响应数据便返回 <code>504</code> 给客户端  </p>
<h3 id="复现504状态码"><a href="#复现504状态码" class="headerlink" title="复现504状态码"></a>复现504状态码</h3><p><code>fastcgi_read_timeout</code> 设置为 <code>3</code><br><code>fastcgi_read_timeout</code> 设置为 <code>10</code><br><code>index.php</code> 的休眠时间设置为 <code>5</code></p>
<p>执行下面的请求</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -H <span class="string">"Host:m.test.com"</span> 127.0.0.1</span><br></pre></td></tr></tbody></table></figure>

<p>返回</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 504 Gateway Time-out</span><br><span class="line">Server: openresty/1.13.6.2</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>看下 <code>Nginx</code> 的 <code>access</code> 日志， 类似如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"m.test.com"</span> <span class="string">"HEAD / HTTP/1.1"</span> 504 649</span><br></pre></td></tr></tbody></table></figure>

<p>看下 <code>Nginx</code> 的 <code>error</code> 日志， 类似如下</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020/03/08 13:17:08 [error] 255#0: *3 upstream timed out (110: Connection timed out) while reading response header from upstream, client: 127.0.0.1, server: *.test.com, request: "HEAD / HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: "m.test.com"</span><br></pre></td></tr></tbody></table></figure>

<p>看一下 <code>/tmp/test.log</code> 发现有日志， 说明 <code>PHP</code> 脚本会继续执行完成</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><code>499</code> 是因为请求超过了客户端设置了请求超时时间， 客户端主动关闭连接， <code>Nginx</code> 把这种情况定义为 <code>499</code> 错误进行了响应  </li>
<li><code>500</code> 基本是因为代码语法错误， 导致 <code>CGI</code> 应用程序执行错误， 并把错误结果通知服务器， 服务器响应 <code>500</code> 错误</li>
<li><code>502</code> 是 <code>CGI</code> 应用程序在自身设置的请求处理时间内没有处理完请求， 无法正常响应数据给服务器， 服务器返回 <code>502</code> 错误</li>
<li><code>504</code> 是 <code>CGI</code> 应用程序没能在服务器设置的超时时间内响应数据， 导致服务器返回 <code>504</code> 错误</li>
<li><code>499</code>、<code>502</code>、<code>504</code> 均是由于超时造成的， 区别是超时是超了谁的时间， <code>499</code> 是超了客户端设置的最大连接时间, <code>502</code> 是超了 <code>CGI</code> 应用程序的最大执行时间, <code>504</code> 是超了服务器设置的最大允许读取时间  </li>
</ul>
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script>
          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class="content">
    
      <blockquote>
        
          
            <p>博客内容遵循 <yellow>署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</yellow></p>

          
        
          
            <p>本文永久链接是：<a href="https://tunasx.github.io/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/">https://tunasx.github.io/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  


          
        </div>
        
          


  <section class="meta" id="footer-meta">
    <div class="new-meta-box">
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-03-16T02:06:47+08:00">
  <a class="notlink">
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2020年3月16日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Editing/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i> <p>Editing</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Http/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i> <p>Http</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer" href="http://connect.qq.com/widget/shareqq/index.html?url=https://tunasx.github.io/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/&title=Http状态码499、500、502、504出现原因和复现 - Mr.Tunas&summary=499状态码首先 499 并不是HTTP 协议定义的状态码，而是 Nginx 自己定义的状态码，看下 Nginx 对 499 状态码的定义  
1234567/* * HTTP does not define the code for the case when a client closed * the connection while we are processing its request so we introduce * own code to log such situation when a client has closed the connection * before we even try to send the HTTP header to it */#define NGX_HTTP_CLIENT_CLOSED_REQUEST     499">
          
            <img src="/20200310.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://tunasx.github.io/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/&title=Http状态码499、500、502、504出现原因和复现 - Mr.Tunas&summary=499状态码首先 499 并不是HTTP 协议定义的状态码，而是 Nginx 自己定义的状态码，看下 Nginx 对 499 状态码的定义  
1234567/* * HTTP does not define the code for the case when a client closed * the connection while we are processing its request so we introduce * own code to log such situation when a client has closed the connection * before we even try to send the HTTP header to it */#define NGX_HTTP_CLIENT_CLOSED_REQUEST     499">
          
            <img src="/20200310.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer" href="http://service.weibo.com/share/share.php?url=https://tunasx.github.io/2020/03/16/Notes/HTTP/Http%E7%8A%B6%E6%80%81%E7%A0%81499%E3%80%81500%E3%80%81502%E3%80%81504%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0%E5%92%8C%E5%A4%8D%E7%8E%B0/&title=Http状态码499、500、502、504出现原因和复现 - Mr.Tunas&summary=499状态码首先 499 并不是HTTP 协议定义的状态码，而是 Nginx 自己定义的状态码，看下 Nginx 对 499 状态码的定义  
1234567/* * HTTP does not define the code for the case when a client closed * the connection while we are processing its request so we introduce * own code to log such situation when a client has closed the connection * before we even try to send the HTTP header to it */#define NGX_HTTP_CLIENT_CLOSED_REQUEST     499">
          
            <img src="/20200310.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <section class="prev">
                <span class="art-item-left">
                  <h4>
                    <a href="/2020/03/16/Notes/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0/" rel="prev" title="REDIS设计与实现笔记">
                      <i class="fas fa-chevron-left" aria-hidden="true"></i>
                      
                        REDIS设计与实现笔记
                      
                    </a>
                  </h4>
                  
                    
                    <h6 class="tags">
                       <a class="tag" href="/tags/Redis/"><i class="fas fa-tag" aria-hidden="true"></i> Redis</a> <a class="tag" href="/tags/Note/"><i class="fas fa-tag" aria-hidden="true"></i> Note</a> <a class="tag" href="/tags/Editing/"><i class="fas fa-tag" aria-hidden="true"></i> Editing</a>
                    </h6>
                  
                </span>
              </section>
            
            
              <section class="next">
                <span class="art-item-right" aria-hidden="true">
                  <h4>
                    <a href="/2020/03/16/%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B/CSP%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B/" rel="prev" title="CSP编程模型">
                      
                        CSP编程模型
                      
                      <i class="fas fa-chevron-right" aria-hidden="true"></i>
                    </a>
                  </h4>
                  
                    
                    <h6 class="tags">
                      <a class="tag" href="/tags/CSP/"><i class="fas fa-tag" aria-hidden="true"></i> CSP</a> <a class="tag" href="/tags/Golang/"><i class="fas fa-tag" aria-hidden="true"></i> Golang</a> 
                    </h6>
                  
                </span>
              </section>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Http状态码499、500、502、504出现原因和复现',
      tools: true
    }
  </script>


</div>
<aside class="l_side">
  
  
    
    


  <section class="widget toc-wrapper  card-shadow widget-blur desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class="name">本文目录</span>
    
  </header>


    <div class="content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#499状态码"><span class="toc-number">1.</span> <span class="toc-text">499状态码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#复现499状态码"><span class="toc-number">1.1.</span> <span class="toc-text">复现499状态码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#500状态码"><span class="toc-number">2.</span> <span class="toc-text">500状态码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#502状态码"><span class="toc-number">3.</span> <span class="toc-text">502状态码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#复现502状态码"><span class="toc-number">3.1.</span> <span class="toc-text">复现502状态码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#504状态码"><span class="toc-number">4.</span> <span class="toc-text">504状态码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#复现504状态码"><span class="toc-number">4.1.</span> <span class="toc-text">复现504状态码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </section>


  

  
    
    
  

  <section class="widget category  card-shadow widget-blur desktop">
    
  <header>
    
      <a href="/blog/categories/"><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i><span class="name">文章分类</span></a>
    
  </header>


    <div class="content">
      <ul class="entry navigation">
        
          <li><a class="flat-box" title="/categories/code/" href="/categories/code/" id="categoriescode"><div class="name">code</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/" id="categoriesgolang"><div class="name">golang</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/notes/" href="/categories/notes/" id="categoriesnotes"><div class="name">notes</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/php/" href="/categories/php/" id="categoriesphp"><div class="name">php</div><div class="badge">(1)</div></a></li>
        
      </ul>
    </div>
  </section>


  

  
    
    
  

  <section class="widget tagcloud  card-shadow widget-blur desktop">
    
  <header>
    
      <a href="/blog/tags/"><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class="name">热门标签</span></a>
    
  </header>


    <div class="content">
      <a href="/tags/Actor/" style="font-size: 14px; color: #999">Actor</a> <a href="/tags/CSP/" style="font-size: 14px; color: #999">CSP</a> <a href="/tags/Editing/" style="font-size: 24px; color: #555">Editing</a> <a href="/tags/Erlang/" style="font-size: 14px; color: #999">Erlang</a> <a href="/tags/Golang/" style="font-size: 14px; color: #999">Golang</a> <a href="/tags/Http/" style="font-size: 14px; color: #999">Http</a> <a href="/tags/Note/" style="font-size: 14px; color: #999">Note</a> <a href="/tags/Redis/" style="font-size: 14px; color: #999">Redis</a> <a href="/tags/cgi/" style="font-size: 14px; color: #999">cgi</a> <a href="/tags/endless/" style="font-size: 14px; color: #999">endless</a> <a href="/tags/fast-cgi/" style="font-size: 14px; color: #999">fast-cgi</a> <a href="/tags/golang/" style="font-size: 14px; color: #999">golang</a> <a href="/tags/php/" style="font-size: 14px; color: #999">php</a> <a href="/tags/php-fpm/" style="font-size: 14px; color: #999">php-fpm</a>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix ">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml" class="social fas fa-rss flat-btn" target="_blank" rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:tunasx@163.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382" class="social fas fa-headphones-alt flat-btn" target="_blank" rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        <div class="copyright">
        <p><a href="https:blog.cuteou.cn" target="_blank" rel="noopener">Copyright © 2017-2020 Mr. Tunas</a> | <a href="https://tongji.baidu.com/web/10000176011/overview/index" target="_blank" rel="noopener">百度统计</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href="javascript:void(0)"></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@1.7.4/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js" async></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>




  
  
  
    
<script src="//cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/BBC19066-E176-47C2-9D22-48C81EE5DF6B.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/B18FCBB3-67FD-48CC-B4F3-457BA145F17A.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/00E0F0ED-9F1C-407A-9AA6-545649D919F4.jpeg"],
          {
            duration: "20000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/BBC19066-E176-47C2-9D22-48C81EE5DF6B.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/B18FCBB3-67FD-48CC-B4F3-457BA145F17A.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/00E0F0ED-9F1C-407A-9AA6-545649D919F4.jpeg"],
          {
            duration: "20000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@1.7.4/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "[object Object]";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script>

<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>